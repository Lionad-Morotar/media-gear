# ğŸš€150è¡Œä»£ç å¸¦ä½ å®ç°å°ç¨‹åºä¸­çš„æ•°æ®ä¾¦å¬

## å‰è¨€

åœ¨å°ç¨‹åºé¡¹ç›®ä¸­, æˆ‘ä»¬çš„é€šå¸¸ä¼šä½¿ç”¨åˆ°ä½¿ç”¨åˆ°ä¸€ä¸ªå…¨å±€å¯¹è±¡ä½œä¸ºå„ä¸ªé¡µé¢é€šç”¨çš„æ•°æ®å­˜å‚¨å®¹å™¨, å°†å®ƒç»‘å®šåˆ°appå¯¹è±¡å, å°±èƒ½åœ¨æ¯ä¸€ä¸ªé¡µé¢éƒ½è‡ªç”±çš„æ“çºµè¿™ä¸ªå¯¹è±¡. ç„¶è€Œåœ¨å®è·µä¸­, ç”±äºè¿™ä¸ªå¯¹è±¡åŠå…¶å±æ€§ä¸å…·å¤‡å“åº”å¼æ¡ä»¶, å®ƒä¸èƒ½ç›´æ¥å‚ä¸ä¸šåŠ¡é€»è¾‘çš„ç¼–å†™, èƒ½åŠ›ä»…ä»…å±€é™äºæ•°æ®å‚¨å­˜. è‹¥æ˜¯åœ¨VueJSé¡¹ç›®ä¸­, æˆ‘ä»¬å¯èƒ½ç»å¸¸ä½¿ç”¨åˆ°`Vue.$watch`å»ä¾¦å¬æŸä¸ªæ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–, å°ç¨‹åºå´ç¼ºä¹è¿™ç§èƒ½åŠ›.

åœ¨è¿™ç¯‡æ–‡ç« ä¸­, æˆ‘å°†ç”¨150è¡Œä»£ç , æ‰‹æŠŠæ‰‹å¸¦ä½ æ‰“é€ ä¸€ä¸ªå°ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨çš„ä¾¦å¬å™¨VX:

```JS
// ä¸€ä¸ªå¿«é€Ÿèµ‹å€¼çš„è¯­æ³•ç³–å‡½æ•°, å¯ä»¥åˆ›å»ºç»“æ„ä¸º { value: a { b: { val: ''} } } çš„å¯¹è±¡
vx.set('value.a.d', { val: '' })
// å¯¹æŸä¸ªå±æ€§è¿›è¡Œä¾¦å¬, å¦‚æœå‘ç”Ÿæ”¹å˜, åˆ™æ‰§è¡Œç›¸åº”å‡½æ•°(å¯å¤šæ¬¡watchä»¥æ‰§è¡Œå¤šä¸ªå‡½æ•°)
vx.watch('value.a.d.val', newVal => {
  console.log(`valæ”¹å˜ä¸º : `, newVal)
})
value.a.d.val = 3 // valæ”¹ç¼–ä¸º : 3
```

ä½¿ç”¨VXä¾¦å¬å™¨, æˆ‘ä»¬å¯ä»¥æ›´åŠ æ–¹ä¾¿çš„ç®¡ç†å„ä¸ªé¡µé¢çš„çŠ¶æ€. åŒæ—¶, æˆ‘ä»¬å‡­å€Ÿ`watch`è¯­æ³•, å¯ä»¥æ›´ä¼˜é›…åœ°ç¼–å†™ä¸šåŠ¡é€»è¾‘.

åç¨³äº†, ä¸‰è½®è½¦å‡†å¤‡å¯åŠ¨äº†~ å„ä½è¯„è®ºè§~ ğŸ˜‹

## ç¨å¾®ç†ä¸€ç†æ€è·¯

åœ¨å…¨å±€å¯¹è±¡ä¸­, æˆ‘ä»¬ä¸ä¸€å®šè¦å¯¹æ¯ä¸€ä¸ªå±æ€§éƒ½è¿›è¡Œä¾¦å¬, æ‰€ä»¥VXä¸»è¦çš„åŠŸèƒ½å°±æ˜¯é€šè¿‡setå»è®¾ç½®æŸä¸ªå…·ä½“å±æ€§çš„setter/getter, åŒæ—¶é€šè¿‡watchå‘æ·»åŠ è¯¥å±æ€§æ·»åŠ éœ€è¦è®¢é˜…çš„å›è°ƒå‡½æ•°.

## ä¾èµ–å¯¹è±¡çš„å®ç°

é¦–å…ˆæˆ‘ä»¬éœ€è¦é€ ä¸€ä¸ªé€šç”¨çš„**ä¾èµ–å¯¹è±¡**, ä¾èµ–å¯¹è±¡æºå¸¦ä¸€ä¸ªè®¢é˜…æ•°ç»„ç”¨äºå­˜æ”¾ä¸€ç»„å›è°ƒå‡½æ•°, åŒæ—¶å®ƒè¿˜åº”è¯¥åŒ…æ‹¬ä¸€äº›æ“ä½œè®¢é˜…æ•°ç»„èƒ½åŠ›(å¦‚æ·»åŠ è®¢é˜…, æ¸…ç©ºè®¢é˜…)çš„å‡½æ•°

```JS
class Dep {
  constructor () {
    this.subs = []
  }
  addSub (fn) { /*...*/ }
  delSub (fn) { /*...*/ }
  // å°†å›è°ƒæ·»åŠ åˆ°æ•°ç»„ä¸­
  collect (fn) {
    if (fn && !this.subs.find(x => x === fn)) {
      this.addSub(fn)
    }
  }
  // æ‰§è¡Œæ•°ç»„ä¸­æ¯ä¸€é¡¹å‡½æ•°
  notify (newVal, oldVal) {
    this.subs.forEach(func => func(newVal, oldVal))
  }
}
```

å…¨å±€å¯¹è±¡ä¸­æ¯ä¸€ä¸ªå“åº”å¼å±æ€§(åŠå…¶æ¯ä¸€ä¸ªå­å±æ€§), éƒ½åº”è¯¥å’Œä¸€ä¸ªæ–°çš„Depå®ä¾‹ä¿æŒä¸€ä¸€å¯¹åº”çš„å…³ç³», è¿™æ ·æˆ‘ä»¬è¿›è¡Œä¾¦å¬å˜åŒ–, æ‰§è¡Œè®¢é˜…çš„å›è°ƒå‡½æ•°æ—¶, åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹æ‰§è¡Œ`notify`é€šçŸ¥æ›´æ–°å³å¯.

## è®¾ç½®å“åº”å¼å±æ€§

### defineProperty

å¯èƒ½æ˜¯å› ä¸ºæ¥è§¦DefinePropertyè¦æ¯”æ¥è§¦Proxyæ—©ä¸€äº›çš„ç¼˜æ•…, ä»£ç ä½¿ç”¨äº†å‰è€…è¿›è¡Œå“åº”å¼çš„å®ç°, Object.definePropertyæ–¹æ³•ä¼šç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§, è¿™é‡Œå¿«é€Ÿè¿‡ä¸€é`defineProperty`å…·ä½“é…ç½®:

```JS
// @param obj è¦åœ¨å…¶ä¸Šå®šä¹‰å±æ€§çš„å¯¹è±¡
// @param key è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°
Object.defineProperty(obj, key, {
  // è¯¥å±æ€§æ˜¯å¦èƒ½è¢«æšä¸¾
  enumerable: true,
  // è¯¥å±æ€§èƒ½å¦è¢«åˆ é™¤
  configurable: true,
  // è®¿é—®è¯¥å±æ€§åˆ™ä¼šæ‰§è¡Œæ­¤æ–¹æ³•
  get: () => {
    return val
  },
  // ä¿®æ”¹è¯¥å±æ€§æ—¶ä¼šæ‰§è¡Œæ­¤æ–¹æ³•
  set: newVal => {
    val = newVal
  },
  // value & writeble ä¸èƒ½å’Œ getter/setter åŒæ—¶å‡ºç°
})
```

é€šè¿‡å¯¹definePropertyè¿›è¡Œä¸Šå±‚å°è£…, æˆ‘ä»¬å¯ä»¥è½»æ¾çš„å®ç°åœ¨å…¨å±€å¯¹è±¡ä¸Šè®¾ç½®å“åº”å¼å±æ€§åŠŸèƒ½, åœ¨æ­¤, æˆ‘ä»¬ç»“åˆåˆšæ‰å®šä¹‰çš„Depå¯¹è±¡, å°†ä¸€ä¸ªæ–°çš„depå®ä¾‹ç»‘å®šåˆ°æ–°å¢å±æ€§çš„setterä¸­:

```JS
set (key, val, options = {}, obj = this.store) {
  const dep = new Dep()
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: () => {
      return val
    },
    set: newVal => {
      if (newVal === val) {
        return
      }
      dep.notify(newVal, val)
      val = newVal
    }
  })
}
```

æ¯å½“å¯¹åº”å±æ€§è¢«èµ‹å€¼, å°±ä¼šæ‰§è¡Œä¾èµ–æ•°ç»„ä¸­çš„å›è°ƒå‡½æ•°.

ä¸è¿‡è¿™æ ·è¿˜ä¸å¤Ÿ, æˆ‘ä»¬è¿˜å¾—æƒ³åŠæ³•è·å–åˆ°è¿™ä¸ªdepå®ä¾‹, æ‰èƒ½ç»™å®ƒçš„ä¾èµ–æ•°ç»„å¡«å……å‡½æ•°.

è¿™è¾¹æä¾›ä¸€ä¸ªå¾ˆç®€å•çš„æ€è·¯, å¹¶ä¸æ¨èå®è·µä¸­è¿™ä¹ˆåš:

```diff
set (key, val, options = {}, obj = this.store) {
  const dep = new Dep()
  Object.defineProperty(obj, key, {})
+ return dep
}
```

```JS
const valueDep = set('value', b, {})
valueDep.addSub(() => { console.log('value changed!') })
```

è™½ç„¶ä»£ç èƒ½ä½¿ç”¨äº†, å°±æ˜¯æ˜¯çœ‹èµ·æ¥æ€ªæ€ªçš„~ ğŸ˜‹ æˆ‘ä»¬çš„ä¸‰è½®è½¦å¼€è¿›äº†å²”è·¯~

## é€šè¿‡watchæ·»åŠ è®¢é˜…

### å–å£æ°´æˆ‘ä»¬ç»§ç»­

<é»‘å®¢ä¸ç”»å®¶>ä¸€ä¹¦ä¸­æ›¾ç»æåˆ°è¿™æ ·ä¸€ä¸ªè§‚ç‚¹, æˆ‘æ·±æœ‰ä½“ä¼š:

> å¦‚æœä½ è§‰å¾—ä½ çš„ä»£ç å¥‡æ€ª, é‚£ä¹ˆå¾€å¾€å®ƒæ˜¯é”™çš„

ä¸Šé¢çš„é‚£ä¸€ä¸²ä»£ç ä»…ä»…æ˜¯èƒ½è·‘é€šçš„æ°´å¹³, æˆ‘ä»¬éœ€è¦åŠ å…¥æ›´å¤šçš„ç»†èŠ‚å’Œæ€è€ƒ, æœ‰æ—¶å€™åªéœ€è¦åä¸‹æ¥ç¨å¾®çœ‹ä¸€ä¸‹ä»£ç , å°±ä¼šæœ‰å„ç§æƒ³æ³•è¹¦å‡ºæ¥:

> æ„æ€è¿™ç§ä¸œè¥¿æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒä¼šå¯¼è‡´æ›´å¤šçš„æ„æ€ã€‚ä½ æœ‰æ²¡æœ‰æ³¨æ„è¿‡ï¼Œåä¸‹æ¥å†™ä¸œè¥¿çš„æ—¶å€™ï¼Œä¸€åŠçš„æ„æ€æ˜¯å†™ä½œæ—¶äº§ç”Ÿçš„ï¼Ÿ

## éšè—Dep


è¿™äº›å†…å®¹åº”å’Œå¤–éƒ¨æ˜¯è§£è€¦çš„. é¦–å…ˆä¸€ç‚¹, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¾¦å¬å™¨ç±», ç”¨äºå°è£…æˆ‘ä»¬ä¾¦å¬æ‰€ç”¨åˆ°çš„æ‰€æœ‰æ–¹æ³•, åŒæ—¶, å®ƒå†…å«ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé¡µé¢çŠ¶æ€å‚¨å­˜çš„å®¹å™¨

```JS
class VX {
  constructor () {
    this.store = createStore()
  }
  watch (key, fn, obj) {}
  set (key, val, obj) {}
}

function createStore () {
  const newStore = Object.create(null)
  return newStore
}
```

æˆ‘ä»¬çš„VXå¯¹è±¡, 

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹, æˆ‘ä»¬ä»¿ç…§VueJSä¸­æ€è·¯, ä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„å¯¹è±¡

## åè¯­


## é¡¹ç›®åœ°å€

> [Githubç›´è¾¾](https://github.com/Lionad-Morotar/media-gear/blob/master/src/renderer/utils/suites/vx/index.js)