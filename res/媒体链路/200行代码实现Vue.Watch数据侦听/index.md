# ğŸš€150è¡Œä»£ç å¸¦ä½ å®ç°Vue.Watchæ•°æ®ä¾¦å¬

## å‰è¨€

åœ¨Vueé¡¹ç›®ä¸­, æˆ‘ä»¬ç»å¸¸ä½¿ç”¨åˆ°`Vue.$watch`å»ä¾¦å¬ä¸€ä¸ªæ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–, å¦‚æœå‘ç”Ÿå˜åŒ–åˆ™æ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°. åœ¨ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸­, æˆ‘å°†æ‰‹æŠŠæ‰‹å¸¦ä½ æ‰“é€ ä¸€ä¸ªä¾¦å¬å™¨, å®ƒå¯ä»¥è¿™æ ·ä½¿ç”¨:

```JS
// ä¸€ä¸ªå¿«é€Ÿèµ‹å€¼çš„è¯­æ³•ç³–å‡½æ•°, å¯ä»¥åˆ›å»ºå½¢å¦‚ { value: a { b: { val: ''} } } çš„å¯¹è±¡
vx.set('value.a.d', { val: '' })
// å¯¹æŸä¸ªå±æ€§è¿›è¡Œä¾¦å¬, å¦‚æœå‘ç”Ÿæ”¹å˜, åˆ™æ‰§è¡Œç›¸åº”å‡½æ•°(å¯å¤šæ¬¡watchä»¥æ‰§è¡Œå¤šä¸ªå‡½æ•°)
vx.watch('value.a.d.val', newVal => {
  console.log(`valæ”¹å˜ä¸º : `, newVal)
})
```

åç¨³äº†, ä¸‰è½®è½¦å‡†å¤‡å¯åŠ¨äº†~ å„ä½è¯„è®ºè§~ ğŸ˜‹

## ç¨å¾®ç†ä¸€ç†æ€è·¯

åœ¨æˆ‘ä»¬çš„å°ç¨‹åºä¸­, ä½¿ç”¨åˆ°ä¸€ä¸ªå…¨å±€å¯¹è±¡ä½œä¸ºä¸€äº›å„ä¸ªé¡µé¢é€šç”¨æ•°æ®çš„å­˜å‚¨, ä¸€å¼€å§‹æˆ‘çš„æƒ³æ³•å¾ˆç®€å•, æˆ‘æƒ³åšä¸€ä¸ªå¯ä»¥ä¾¦å¬è¿™ä¸ªå…¨å±€å¯¹è±¡æŸä¸ªå±æ€§çš„ä¾¦å¬å™¨, åªè¦æ»¡è¶³**ç®€å•**å’Œ**å“åº”å¼**è¿™ä¸¤ä¸ªæ¡ä»¶å°±å¥½.

é‚£ä¹ˆå…ˆåšæ•°æ®ç»“æ„çš„é¢„ä¼°, æ—¢ç„¶æƒ³è¦è¾¾åˆ°å¯¹å±æ€§ä¾¦å¬æ‰§è¡Œå›è°ƒçš„åŠŸèƒ½, é‚£ä¹ˆ:

1. è‚¯å®šä¼šæ¶‰åŠåˆ°getter/setteré‡Œè§¦å‘å›è°ƒå‡½æ•°è¿™ä¸ªæ“ä½œ
2. å¯èƒ½éœ€è¦è®¾ç½®ä¸€ä¸ªåˆ—è¡¨, ç”¨äºå­˜æ”¾å›è°ƒå‡½æ•°
3. åˆ—è¡¨ä¼šåœ¨å±æ€§çš„setteré‡Œè¢«éå†, è§¦å‘å…¶ä¸­æ‰€æœ‰å›è°ƒå‡½æ•°

## Dep.js

æˆ‘ä»¬å…ˆé€ ä¸€ä¸ªé€šç”¨çš„**ä¾èµ–å¯¹è±¡**, å®ƒè‡ªå¸¦ä¸€ä¸ªæ•°ç»„ç”¨äºå­˜æ”¾å›è°ƒå‡½æ•°, åŒæ—¶å…·æœ‰æ·»åŠ åˆ é™¤å‡½æ•°, æ¸…ç©ºæ•°ç»„, æ‰§è¡Œæ•°ç»„å†…å‡½æ•°ç­‰æ–¹æ³•:

```JS
class Dep {
  constructor () {
    this.subs = []
  }
  addSub (fn) { /*...*/ }
  delSub (fn) { /*...*/ }
  // å°†å›è°ƒæ·»åŠ åˆ°ä¾èµ–æ•°ç»„ä¸­
  collect (fn = watcher) {
    if (fn && !this.subs.find(x => x === fn)) {
      this.addSub(fn)
    }
  }
  // æ‰§è¡Œä¾èµ–æ•°ç»„ä¸­æ¯ä¸€ä¸ªå‡½æ•°
  notify (newVal, oldVal) {
    this.subs.forEach(func => func(newVal, oldVal))
  }
}
```

åœ¨`collect`å‡½æ•°ä¸­, æˆ‘ä»¬å¯¹`fn`æ–¹æ³•è¿›è¡Œäº†åˆ¤æ–­ä¸é‡å¤ç„¶åæ·»åŠ åˆ°`subs`ä¸­è¿™æ ·ä¸€ä¸ªæ“ä½œ, å¯ä»¥çœ‹åˆ°ä»–çš„é»˜è®¤å€¼æ˜¯`fn = watcher`, è¿™é‡Œç¨åè§£é‡Š~

## defineProperty

### è¿‡ä¸€éå®šä¹‰

å¯èƒ½æ˜¯å› ä¸ºæ¥è§¦DefinePropertyè¦æ¯”æ¥è§¦Proxyæ—©ä¸€äº›, è¿™è¾¹ä»£ç ä½¿ç”¨äº†å‰è€…è¿›è¡Œå®ç°, è¿™é‡Œå¿«é€Ÿè¿‡ä¸€é`defineProperty`å…·ä½“é…ç½®:

```JS
// @param obj è¦åœ¨å…¶ä¸Šå®šä¹‰å±æ€§çš„å¯¹è±¡
// @param key è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°
Object.defineProperty(obj, key, {
  // è¯¥å±æ€§æ˜¯å¦èƒ½è¢«æšä¸¾
  enumerable: true,
  // è¯¥å±æ€§èƒ½å¦è¢«åˆ é™¤
  configurable: true,
  // è®¿é—®è¯¥å±æ€§åˆ™ä¼šæ‰§è¡Œæ­¤æ–¹æ³•
  get: () => {
    return val
  },
  // ä¿®æ”¹è¯¥å±æ€§æ—¶ä¼šæ‰§è¡Œæ­¤æ–¹æ³•
  set: newVal => {
    val = newVal
  },
  // value & writeble ä¸èƒ½å’Œ getter/setter åŒæ—¶å‡ºç°
})
```

### ç»“åˆDep.js

æ˜¾è€Œæ˜“è§, æˆ‘ä»¬åªéœ€è¦åŠ ä¸Šä¸¤å¥å°±å¯ä»¥å®Œæˆè¿™éƒ¨åˆ†é€»è¾‘:

```diff
+ const dep = new Dep()
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: () => {
      return val
    },
    set: newVal => {
      val = newVal
+     dep.notify(newVal, val)
    }
  })
```

æ­¤åæ¯å½“å¯¹åº”å±æ€§è¿›è¡Œæ›´æ–°æ“ä½œ, é‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¾èµ–æ•°ç»„ä¸­çš„å›è°ƒå‡½æ•°.

ä¸è¿‡è¿™æ ·è¿˜ä¸å¤Ÿ, æˆ‘ä»¬è¿˜å¾—æƒ³åŠæ³•è·å–åˆ°è¿™ä¸ªdepå®ä¾‹, æ‰èƒ½ç»™å®ƒçš„ä¾èµ–æ•°ç»„å¡«å……å‡½æ•°.

è¿™è¾¹æä¾›ä¸€ä¸ªå¾ˆç®€å•çš„æ€è·¯:

```diff
+ set (key, val, obj) {
    const dep = new Dep()
    Object.defineProperty(obj, key, {
      enumerable: true,
      configurable: true,
      get: () => {
        return val
      },
      set: newVal => {
        val = newVal
        dep.notify(newVal, val)
      }
    })
+   return dep
+ }
```

å°†`defineProperty`å°è£…æˆä¸€ä¸ªå‡½æ•°è°ƒç”¨, æœ€åè¿”å›è¿™ä¸ª`dep`å®ä¾‹, è¿™æ ·çš„è¯æˆ‘ä»¬å¯ä»¥åœ¨å®é™…ä¸šåŠ¡ä¸­è¿™æ ·å»ä½¿ç”¨:

```JS
const valueDep = set('value', b, {})
valueDep.addSub(() => { console.log('value changed!') })
```

è™½ç„¶ä»£ç èƒ½ä½¿ç”¨äº†, ä½†æ˜¯çœ‹èµ·æ¥å“ªé‡Œæ€ªæ€ªçš„?
ä¸è¿‡è‡³å°‘ç›®å‰ä¸ºæ­¢, æˆ‘ä»¬æƒ³è¦çš„**ç®€å•**, **å“åº”å¼**ä¸¤ä¸ªåŠŸèƒ½éƒ½å®Œæˆäº†, ä¸‰è½®è½¦ç†„ç«~

## æ–°æ„æ€

<é»‘å®¢ä¸ç”»å®¶>ä¸€ä¹¦ä¸­æ›¾ç»æåˆ°è¿™æ ·ä¸€ä¸ªè§‚ç‚¹, æˆ‘æ·±æœ‰ä½“ä¼š:

> å¦‚æœä½ è§‰å¾—ä½ çš„ä»£ç å¥‡æ€ª, é‚£ä¹ˆå¾€å¾€å®ƒçš„å®ç°æ˜¯é”™çš„

ä¸Šé¢çš„é‚£ä¸€ä¸²ä»£ç ä»…ä»…æ˜¯èƒ½è·‘é€šçš„æ°´å¹³, æˆ‘ä»¬éœ€è¦åŠ å…¥æ›´å¤šçš„ç»†èŠ‚å’Œæ€è€ƒ, æœ‰æ—¶å€™åªéœ€è¦åä¸‹æ¥ç¨å¾®çœ‹ä¸€ä¸‹ä»£ç , å°±ä¼šæœ‰å„ç§æƒ³æ³•è¹¦å‡ºæ¥:

> æ„æ€è¿™ç§ä¸œè¥¿æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒä¼šå¯¼è‡´æ›´å¤šçš„æ„æ€ã€‚ä½ æœ‰æ²¡æœ‰æ³¨æ„è¿‡ï¼Œåä¸‹æ¥å†™ä¸œè¥¿çš„æ—¶å€™ï¼Œä¸€åŠçš„æ„æ€æ˜¯å†™ä½œæ—¶äº§ç”Ÿçš„ï¼Ÿ

(å–å£æ°´æˆ‘ä»¬ç»§ç»­)

## éšè—Dep

æˆ‘å¸Œæœ›åœ¨ä½¿ç”¨è¿™ä¸ªä¾¦å¬å™¨çš„æ—¶å€™:

1. ä¸éœ€è¦å°†å…¨å±€å¯¹è±¡æ˜¾å¼ä¼ é€’è¿›å»
2. ä¸è¦æ˜¾å¼è°ƒç”¨ä»»ä½•`Dep.js`å®šä¹‰çš„å‡½æ•°

è¿™äº›å†…å®¹åº”å’Œå¤–éƒ¨æ˜¯è§£è€¦çš„. é¦–å…ˆä¸€ç‚¹, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¾¦å¬å™¨ç±», ç”¨äºå°è£…æˆ‘ä»¬ä¾¦å¬æ‰€ç”¨åˆ°çš„æ‰€æœ‰æ–¹æ³•, åŒæ—¶, å®ƒå†…å«ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé¡µé¢çŠ¶æ€å‚¨å­˜çš„å®¹å™¨

```JS
class VX {
  constructor () {
    this.store = createStore()
  }
  watch (key, fn, obj) {}
  set (key, val, obj) {}
}

function createStore () {
  const newStore = Object.create(null)
  return newStore
}
```

æˆ‘ä»¬çš„VXå¯¹è±¡, 

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹, æˆ‘ä»¬ä»¿ç…§VueJSä¸­æ€è·¯, ä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„å¯¹è±¡

## åè¯­


## é¡¹ç›®åœ°å€

> [Githubç›´è¾¾](https://github.com/Lionad-Morotar/media-gear/blob/master/src/renderer/utils/suites/vx/index.js)